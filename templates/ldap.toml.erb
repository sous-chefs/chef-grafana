#
# Generated by Chef for <%= node['fqdn'] %>
# Do NOT modify this file by hand.
#

<% if @ldap['log_filters'] %>
# To troubleshoot and get more log info enable ldap debug logging in grafana.ini
[log]
filters = <%= @ldap['log_filters'] %>
<% end %>

<% unless @ldap['servers'].nil? %>
<% @ldap['servers'].each do | key, server | %>
# Map ldap groups to grafana org roles
[[servers]]
# Ldap server host (specify multiple hosts space separated)
host = "<%= key %>"
<% unless server['port'].nil? -%>
port = <%= server['port'] %>
<% end -%>
<% unless server['use_ssl'].nil? -%>
use_ssl = <%= server['use_ssl'] %>
<% end -%>
<% unless server['start_tls'].nil? -%>
start_tls = <%= server['start_tls'] %>
<% end -%>
<% unless server['ssl_skip_verify'].nil? -%>
ssl_skip_verify = <%= server['ssl_skip_verify'] %>
<% end -%>

<% unless server['root_ca_cert'].nil? -%>
root_ca_cert = "<%= server['root_ca_cert'] %>"
<% end -%>
<% unless server['client_cert'].nil? -%>
client_cert = "<%= server['client_cert'] %>"
<% end -%>
<% unless server['client_key'].nil? -%>
client_key = "<%= server['client_key'] %>"
<% end -%>

<% unless server['bind_dn'].nil? -%>
bind_dn = "<%= server['bind_dn'] %>"
<% end -%>
<% unless server['bind_password'].nil? -%>
bind_password = "<%= server['bind_password'] %>"
<% end -%>

<% unless server['search_filter'].nil? -%>
search_filter = "<%= server['search_filter'] %>"
<% end -%>
<% unless server['search_base_dns'].nil? -%>
search_base_dns = <%= server['search_base_dns'] %>
<% end -%>

<% unless server['group_search_filter'].nil? -%>
group_search_filter = "<%= server['group_search_filter'] %>"
<% end -%>
<% unless server['group_search_base_dns'].nil? -%>
group_search_base_dns = <%= server['group_search_base_dns'] %>
<% end -%>
<% unless server['group_search_filter_user_attribute'].nil? -%>
group_search_filter_user_attribute = "<%= server['group_search_filter_user_attribute'] %>"
<% end -%>
<% end # servers loop -%>
<% end # servers unless -%>

# Specify names of the ldap attributes your ldap uses
[servers.attributes]
<% if @ldap['servers_attributes_name'] %>
name = "<%= @ldap['servers_attributes_name'] %>"
<% end %>
<% if @ldap['servers_attributes_surname'] %>
surname = "<%= @ldap['servers_attributes_surname'] %>"
<% end %>
<% if @ldap['servers_attributes_username'] %>
username = "<%= @ldap['servers_attributes_username'] %>"
<% end %>
<% if @ldap['servers_attributes_member_of'] %>
member_of = "<%= @ldap['servers_attributes_member_of'] %>"
<% end %>
<% if @ldap['servers_attributes_email'] %>
email = "<%= @ldap['servers_attributes_email'] %>"
<% end %>

# Map ldap groups to grafana org roles
<% unless @ldap['group_mappings'].nil? %>
<% @ldap['group_mappings'].each do | group | %>

[[servers.group_mappings]]
<% group.each do |k, v| %>
<% next if v.nil? %>
<%= k.to_s %> = <%= v.is_a?(String) ? "\"#{v}\"" : v %>
<% end %>

<% end -%>
<% end -%>
